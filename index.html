<script src="https://cdn.jsdelivr.net/npm/vue@3.2.31/dist/vue.global.js"></script>
<script src="https://unpkg.com/vue-router@4"></script>

<div id="app"></div>

<script type="module">
  ////////////////////////////////////////////////////////////////////////////////
  // vue3-sfc-loader モジュール
  ////////////////////////////////////////////////////////////////////////////////
  import { loadModule } from "https://cdn.jsdelivr.net/npm/vue3-sfc-loader@0.8.4/dist/vue3-sfc-loader.esm.js";

  ////////////////////////////////////////////////////////////////////////////////
  // vue3-sfc-loader オプション
  // SFCファイルから外部のモジュールをimportできるオプション
  // 参考：https://github.com/FranckFreiburger/vue3-sfc-loader/issues/14#issuecomment-908849863
  ////////////////////////////////////////////////////////////////////////////////
  const vue3_sfc_loader_options = {
    moduleCache: { vue: Vue },
    getFile(url) {
      url = /.*?\.js|.mjs|.css|.less|.vue$/.test(url) ? url : `${url}.vue`;
      const type = /.*?\.js|.mjs$/.test(url)
        ? ".mjs"
        : /.*?\.vue$/.test(url)
        ? ".vue"
        : /.*?\.css$/.test(url)
        ? ".css"
        : ".vue";
      const getContentData = (asBinary) =>
        fetch(url).then((res) =>
          !res.ok
            ? Promise.reject(url)
            : asBinary
            ? res.arrayBuffer()
            : res.text()
        );
      return { getContentData: getContentData, type: type };
    },
    addStyle(textContent) {
      let styleElement = document.createElement("style");
      document.head.insertBefore(
        Object.assign(styleElement, { textContent }),
        document.head.getElementsByTagName("style")[0] || null
      );
    },
    handleModule(type, getContentData, path, options) {
      switch (type) {
        case ".css":
          return options.addStyle(getContentData(false));
        case ".less":
          console.error(".......");
      }
    },
    log(type, ...args) {
      console.log(type, ...args);
    },
  };

  ////////////////////////////////////////////////////////////////////////////////
  // Vue.js アプリケーションインスタンス
  ////////////////////////////////////////////////////////////////////////////////
  const routes = [
    {
      path: "/",
      component: Vue.defineAsyncComponent(() =>
        loadModule("./views/HomeView.vue", vue3_sfc_loader_options)
      ),
    },
    {
      path: "/about",
      component: Vue.defineAsyncComponent(() =>
        loadModule("./views/AboutView.vue", vue3_sfc_loader_options)
      ),
    },
  ];

  const router = VueRouter.createRouter({
    history: VueRouter.createWebHashHistory(),
    routes,
  });

  const app = Vue.createApp({
    components: {
      App: Vue.defineAsyncComponent(() =>
        loadModule("./AppView.vue", vue3_sfc_loader_options)
      ),
    },
    template: `<App/>`,
  });
  app.use(router);
  app.mount("#app");
</script>
